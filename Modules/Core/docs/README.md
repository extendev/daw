<style>
body {
    font-family: Helvetica, arial;
    font-size: 14px;
    width: 960px;
}
h1 {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    margin-left: -2px;
}
h2 {
    font-size: 22px;
}
blockquote {
    padding-left: 10px;
    color: #CCC;
}
p {
    margin-top: 5px;
}
blockquote p strong {
    color: #666;r
}
.toc {
    float: right;
    font-size: 12px;
    font-weight: bold;
    line-height: 12px;
    font-family: helvetica, Arial;
    background: white;
    border-left: 2px solid #DDD;
    margin-left: 20px;
    padding-left: 0px;
    color: #009;
    padding-right: 20px;
}
.toc li {
    margin-top: 2px;
}
.toc li li {
    font-weight: bold;
}
.toc li li a,
.toc li li a:visited {
    color: #00C;
}
.toc li li li {
    font-weight: normal;
}
.toc li li li a,
.toc li li li a:visited {
    color: #00F;
}
.toc ul {
    margin-top: 5px;
    list-style-type: none;
    padding-left: 10px;
}
</style>

<div class='toc'>
[toc]
</div>

# Daw Core - Module Presentation
> Current version: 1.0

Core is the Daw[^daw] module provided by default when installing the application. It provides some objects and providers in order to be able to use Daw right away without having to code anything. All functionnalities offered by the Core module could then be extended or replaced by other modules without any problem.


Core module brings the following features:
 - `Log management` through the implementation of *LogProvider* provider.
 - `Cache support` through the implementation of *CacheProvider* provider.
 - `User authentication` and `access permissions` through the implementation of *SecurityProvider* provider.

Along with these features, following objects are also published by the module:
 - `User` object, used by the *SecurityProvider* to store information of a Daw user.

 At last, various operations are also published by the module to offer management of Daw internal objects or its own objects:
 - `User`, for adding, updating, removing users
 - `Module`, for listing and retrieving information of registered modules
 - `Object`, for listing and retrieving information of objects published by all registered modules
 - `Operation`, for listing and retrieving information of available operations published by modules and that user may be able to call


 They will be detailed in the *Operations* section.


## Providers

### Log Provider

This provider supports different storage solutions for saving logs, and also implement filtering to define for which classes and starting with which severity level it shall start storing logs.

All is configurable using a `log.yml` file to be available in the *conf/* directory of the application.


#### Storage Facilities

Facilities define where logs shall be stored. There are 3 different storage options supported:
- `syslog` message will be stored using [syslog()](http://php.net/manual/function.syslog.php) PHP method. No additional parameters is requested.
- `file`
- `errorlog` message will be stored using [error_log()](http://php.net/manual/function.error_log.php) PHP method. Parameters corresponding to the function arguments shall be specified as:

    errorlog 1 <an email address that will receive the log message>
    errorlog 3 <a file where to append the log in>
    errorlog 4 log message is sent to SAPI manager


The provider supports an unlimited number of facilities. All shall be stored in the `facilities` section as a key-value name, key being the name of the facility that can be used later in the log configuration file.

    # Where to store logs
    facilities:
       system: syslog
       error: file var/logs/daw-error.log
       debug: file var/logs/daw-debug.log
       default: file var/logs/daw.log


#### Filters

The provider also allows user to confgigure how logs shall be processed, i.e. to which facility shall they be dispatched and if they have a certain criticity level. All this configuration is performed in the `levels` section:

    # Levels used per namespace / class
    levels:
        "Daw\\Modules\\Core\\Operations\\Help" FATAL errorlog
        "Daw\\Modules\\Core": NOTICE noticelog
        "Daw": TRACE tracelog

Each line is a key value pair using following format:

        <log source namespace>: <level> <facility>
        where
          <log source namespace> is the complete or part of namespace of the class that triggers the log generation
          <level> the level from which the log is considered as to be processed
          <facility> if to be processed, to which facility the log shall be dispatched

As *log source namespace* may be just a part of namespace, a single "index of" check will be performed to know if log has to be processed by a line.

For example, given the above example:
- logs generated by the class *Daw\\Modules\\Core\\Operations\\Help* will be processed by first linedispatched to errorlog facility if its level is FATAL
- logs generated by the class *Daw\\Modules\\Core\\Operations* will be dispatched to noticelog facility if its level is at least NOTICE
- All logs that matching first 2 lines will be dispatched to tracelog


The configuration file also provides `defaultLevel` and `defaultFacility` to let users specify a last filter if no lines in the *level* section have matched.

    # Default settings
    defaultLevel: TRACE
    defaultFacility: errorlog



### Cache Provider

This providers provides a very basic cache management system by storing cached data into a plain file. All data stored is serialized using PHP default serialization process, so users need to watch out of properties like active file or socket descriptors. See [PHP manual](http://php.net/manual/function.serialize.php) for more information related to serialization.

The location of the file can be configured via the `conf/cache.yml` configuration file:

    file: /var/run/daw/daw.cache



### Security Provider

This provider offers a first level of security for the application by supporting both authentication and access permission features. For this, the module publishes a new `User` object that will be used to store user information and manage their access. You can review the object section for getting more information about user information.



#### User Authentication

The user authentication performed here is a simple credentials validation process:
- The provider gets the username and password from the service authentication token
- The provider verifies if a user exists for the given username and is active
- If the user exists, the provider compares the given password with user stored password.

If user exists, is active and his password is valid, the user will be authenticated and will be granted access to the application.

##### Application Settings

It is possible to enable or disable completely the authentication by updating `authentication > enable` setting in application configuration file `conf/security.yml`.

    authentication:
      enable: true               # true|false


Blacklisting users is also possible through the `authentication > enable` setting. All users identified by their username in this setting will be prevented to access the application, even if their credentials are valid.

    authentication:
      blacklist: guest daemon    # list of usernames



#### Access Permission

Once a user has been authenticated, the security provider will also verify that the user has the right to access the operation he requested.

For this, a section called `access` available in `conf/security.yml` configuration file allows users to define simple ACLs:
- For each operation, it will be possible to specify `default`, `deny` and `allow` setting:
- `default` defines the default access to apply if no other rules match: *deny* all users or *allow* access to all users
- `deny` and `allow` setting then accepts a list of usernames. This will define the access for these users, overriding the `default` setting


    access:
      default: deny                    # allow|deny,
      operations:                      # access per operatoins
        core.help:
          allow: all
        "admin.*":
          default: deny
          allow: admin

Some remarks:
- A global `default` setting is also available, specifying the defaut behavior if none of the rules defined after match
- the operation name format is the following:

    [<module>.]<operation name>

    where
      <module> is the name of the module implementing the operation. It may be optional if only one module implements the operation
      <operation> is the name of the operation. It may be replaced by an asterisk (*) if a module has been set to specify 'all operations of this module'






## Objects

### User

Daw user as implemented by Core module, identified by a username and password.

### Definition


    id:             User ID. Will be unique across all users.
    name:           User fullname
    username:       User login. Will be unique across all users.
    password:       User password MD5 hash.
    email:          Email address of the user
    active:         Status - TRUE (active) or FALSE (inactive)

User passwords are stored as MD5 hash. A salt is used and provided by the module configuration file using *passworSalt* setting.


### Implementation

Users are implemented by the `Daw\Modules\Core\Objects\User` class. Each instance is stored in a file located in *var/run/users.db*, managed by `Daw\Modules\Core\Store\UserStore` class, a FileStore instance. The data is stored in the file as JSON-encoded text.

*Example:*

      {
          id: 'USER-001',
          name: 'User #1',
          username: 'user01',
          password: 'password MD5 hash',
          active: true,
          email: 'joinh@doe.com'
      }

*Related files:*
- Objects/User.inc
- Store/UserStore.inc




## Operations

### Module

#### module.list

List all modules registered to the application

*Parameters*
> None


#### module.info

This operation returns all information related to a module.

*Parameters*

    name            Module Name
        Required:   Yes
        Format:     String
        Validation: Shall correspond to the name of a module currently registered to the application




### Object

#### object.list

This operation lists all objects available on the application and published by registered modules.

*Parameters*
> None


#### object.info

This operation returns all information related to a site.

*Parameters*

    name            Module Name
        Required:   Yes
        Format:     String
        Validation: Shall correspond to the name of an object published by the application



#### object.optionList

This operation returns a list of all objects of a given type, identified by a key-value pair, key and value being set as a property defined in the object.

*Parameters*

    object          Name of the object to return list of
        Required:   Yes
        Format:     String
        Validation: Shall correspond to the name of an object published by the application

    key            Object property to be used to set keys in key-value pairs
        Required:   Yes
        Format:     String
        Validation: Shall correspond to the name of a property defined in the requested object

    value           Object property to be used to set values in key-value pairs
        Required:   Yes
        Format:     String
        Validation: Shall correspond to the name of a property defined in the requested object


### Operation

#### operation.list

This operation lists all operations published by registered modules

*Parameters*
> None


#### operation.info

This operation returns all information related to a site.

*Parameters*

    object          Name of the object or module to call the operation against
        Required:   Yes
        Format:     String
        Validation: Shall correspond to an object published or a module registered in the application

    operation       Name of the operation
        Required:   Yes
        Format:     String
        Validation: Shall correspond to an operation published by the application



### Provider

#### provider.list

This operation lists all providers made available by modules and that can be used by the application and other modules

*Parameters*
> None



### User

#### user.list

This operation lists all users existing in the application.

*Parameters*
> None


#### user.create

Creates a new site and returns the ID of the new record upon successful creation process.

*Parameters*

    name            User fullname
        Required:   Yes
        Format:     String
        Validation: Free text

    username        Account name
        Required:   Yes
        Format:     String
        Validation: Shall be unique across all users

    password:       Account password
        Required:   No
        Format:     String
        Validation: Free text

    email:          Email Address
        Required:   Yes
        Format:     Email address

    active:         Account Status
        Required:   No
        Format:     true/false


*Results*

The object representing information of the newly created user.



#### user.update

Updates the information of an existing user.

*Parameters*

    user            Account name of user to update
        Required:   Yes
        Format:     String
        Validation: Shall correspond to a valid username of a user existing in the application

    name            Account name to set, if specified
        Required:   No
        Format:     String
        Validation: Free text

    username        Account name to set, if specified
        Required:   No
        Format:     String
        Validation: Shall be unique across all users

    password:       Account password to set, if specified
        Required:   No
        Format:     String
        Validation: Free text

    email:          Email Address to set, if specified
        Required:   No
        Format:     Email address

    active:         Account Status to set, if specified
        Required:   No
        Format:     true/false


#### user.activate

Enable a user - user will be able to authenticate.
It actually sets the `active` property to *true*.

*Parameters*

    username        Username of the user
        Required:   Yes
        Format:     String
        validation: Shall correspond to the username of a user existing in the application


#### user.deactivate

Disable a user - user will not be able to authenticate till enabled back.
It actually sets the `active` property to *false*.

*Parameters*

    username        Username of the user
        Required:   Yes
        Format:     String
        validation: Shall correspond to the username of a user existing in the application


#### user.delete

This operation deletes a user, if this latter is not already deleted. User will not be able to access anymore the application.

*Parameters*

    username        Username of the user
        Required:   Yes
        Format:     String
        validation: Shall correspond to the username of a user existing in the application




### Miscallenaous

#### Version

This operation returns the version of the Daw application

*Parameters*
> None

*Results*

The operation returns the application version as a string

    "1.0"


#### Help

This basic operation just returns a string without performing any processing internally.

It can be used for checking application settings and testing if operations can be properly called without taking into account any workflow that could be induced by the operation requested.

*Parameters*
> None

*Results*

Upon successful processing, the operation shall return the following string:

    You've just reached Daw core module. This means the application is working properly


#### Info

This operation returns the global configuration of the application

*Parameters*
> None

*Results*

The operation will return an object listing all configuration settings parsed by the application at runtime and currently used.

